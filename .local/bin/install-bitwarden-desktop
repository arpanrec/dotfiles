#!/usr/bin/env bash
set -euo pipefail

# https://github.com/bitwarden/clients/releases/download/desktop-v2025.12.1/Bitwarden-2025.12.1-x86_64.AppImage

LATEST_VERSION="2025.12.0"

if [[ -z "${LATEST_VERSION}" ]]; then
    echo "Failed to get latest version."
    exit 1
fi

CURRENT_ARCH="$(uname -m)"

case "${CURRENT_ARCH}" in
x86_64)
    DOWNLOAD_ARCH_KEY="x86_64"
    ;;
*)
    echo "Unsupported architecture: ${CURRENT_ARCH}"
    exit 1
    ;;
esac

TMP_DOWNLOAD_DIRECTORY="${HOME}/Downloads/.from_dotfiles"
APPIMAGE_FILE_NAME="Bitwarden-${LATEST_VERSION}-${DOWNLOAD_ARCH_KEY}.AppImage"
APPIMAGE_INSTALL_DIRECTORY="${HOME}/.local/share/bitwarden-desktop"
DOWNLOAD_URI="https://github.com/bitwarden/clients/releases/download/desktop-v${LATEST_VERSION}/${APPIMAGE_FILE_NAME}"

mkdir -p "${APPIMAGE_INSTALL_DIRECTORY}" "${HOME}/.local/share/applications" "${TMP_DOWNLOAD_DIRECTORY}"

if [[ ! -f "${TMP_DOWNLOAD_DIRECTORY}/${APPIMAGE_FILE_NAME}" ]]; then
    curl -fL "${DOWNLOAD_URI}" -o "${TMP_DOWNLOAD_DIRECTORY}/${APPIMAGE_FILE_NAME}"
else
    echo "AppImage File already exists"
fi
rm -f "${APPIMAGE_INSTALL_DIRECTORY}/bitwarden-desktop.AppImage"
cp "${TMP_DOWNLOAD_DIRECTORY}/${APPIMAGE_FILE_NAME}" "${APPIMAGE_INSTALL_DIRECTORY}/bitwarden-desktop.AppImage"
chmod +x "${APPIMAGE_INSTALL_DIRECTORY}/bitwarden-desktop.AppImage"

tee "${HOME}/.local/share/applications/bitwarden.desktop" <<EOF
[Desktop Entry]
Name=Bitwarden
GenericName=Password Manager
Comment=A secure and free password manager for all of your devices.
Exec=${APPIMAGE_INSTALL_DIRECTORY}/bitwarden-desktop.AppImage %u
Terminal=false
MimeType=x-scheme-handler/bitwarden
Type=Application
Icon=bitwarden
Categories=Utility;
StartupWMClass=Bitwarden
EOF
