#!/usr/bin/env bash
set -euo pipefail

required_cmds=(
    curl
    git
    unzip
    gtk-update-icon-cache
    jq
    fc-cache
    fontforge
)

for cmd in "${required_cmds[@]}"; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Required command '$cmd' is not installed or not in PATH"
        exit 1
    fi
done

TMP_DOWNLOAD_DIRECTORY="${HOME}/.tmp/from_dotfiles_bin"

IS_GNOME_SHELL=false

if command -v gnome-shell &>/dev/null; then
    IS_GNOME_SHELL=true
fi

echo "IS_GNOME_SHELL $IS_GNOME_SHELL"

# "repo_url|target_dir|branch"
declare -a git_repositories=(
    "https://github.com/EliverLara/Nordic.git|${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Nordic|master"
    "https://github.com/EliverLara/Nordic-kde.git|${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Nordic-kde|master"
    "https://github.com/vinceliuice/Layan-kde.git|${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-kde|master"
    "https://github.com/vinceliuice/Layan-gtk-theme.git|${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-gtk-theme|master"
    "https://github.com/EliverLara/Sweet.git|${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Sweet|master"
    "https://github.com/EliverLara/Sweet.git|${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Sweet|mars"

    "https://github.com/vinceliuice/Tela-icon-theme.git|${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Tela-icon-theme|master"
    "https://github.com/EliverLara/candy-icons.git|${TMP_DOWNLOAD_DIRECTORY}/EliverLara/candy-icons|master"
    "https://github.com/vinceliuice/Layan-cursors.git|${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-cursors|master"
    "https://github.com/gvolpe/BeautyLine.git|${TMP_DOWNLOAD_DIRECTORY}/gvolpe/BeautyLine|main"

)

for item in "${git_repositories[@]}"; do
    IFS="|" read -r item_repo item_dir item_branch <<<"${item}"

    echo "Installing ${item_dir}/${item_branch}"

    if [[ ! -d "${item_dir}/${item_branch}" ]]; then
        echo "Cloning ${item_repo} to ${item_dir}/${item_branch}"
        git clone --depth 1 "${item_repo}" "${item_dir}/${item_branch}" --single-branch --branch "${item_branch}"
    else
        echo "${item_dir}/${item_branch} already exists. Updating."
        (
            cd "${item_dir}/${item_branch}" || exit 1
            git pull
        )
    fi
done

mkdir -p "${TMP_DOWNLOAD_DIRECTORY}" "${HOME}/.local/share/themes" "${HOME}/.local/share/color-schemes" \
    "${HOME}/.local/share/plasma/look-and-feel" "${HOME}/.local/share/icons" \
    "${HOME}/.config/Kvantum" "${HOME}/.local/share/konsole" "${HOME}/.local/share/aurorae/themes" \
    "${HOME}/.local/share/fonts" "${HOME}/.local/share/plasma/desktoptheme"

echo "Installing EliverLara/Nordic."

rm -rf "${HOME}/.local/share/themes/Nordic"

cp -r "${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Nordic/master" "${HOME}/.local/share/themes/Nordic"
rm -rf "${HOME}/.local/share/themes/Nordic/.git"

cp -r "${HOME}/.local/share/themes/Nordic/kde/aurorae/." "${HOME}/.local/share/aurorae/themes/"
cp -r "${HOME}/.local/share/themes/Nordic/kde/colorschemes/." "${HOME}/.local/share/color-schemes/"
cp -r "${HOME}/.local/share/themes/Nordic/kde/plasma/look-and-feel/." "${HOME}/.local/share/plasma/look-and-feel/"
cp -r "${HOME}/.local/share/themes/Nordic/kde/kvantum/." "${HOME}/.config/Kvantum/"
cp -r "${HOME}/.local/share/themes/Nordic/kde/konsole/." "${HOME}/.local/share/konsole/"

echo "Installing EliverLara/Nordic-kde."

rm -rf "${HOME}/.local/share/plasma/desktoptheme/Nordic"
cp -r "${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Nordic-kde/master" "${HOME}/.local/share/plasma/desktoptheme/Nordic"
rm -rf "${HOME}/.local/share/plasma/desktoptheme/Nordic/.git"

if [[ ${IS_GNOME_SHELL} == "false" ]]; then
    echo "Installing vinceliuice/Layan-kde."
    chmod +x "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-kde/master/install.sh"
    "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-kde/master/install.sh"
fi

if [[ ${IS_GNOME_SHELL} == "true" ]]; then
    echo "Installing vinceliuice/Layan-gtk-theme."
    chmod +x "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-gtk-theme/master/install.sh"
    "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-gtk-theme/master/install.sh"
fi

echo "Installing EliverLara/Sweet/mars."

rm -rf "${HOME}/.local/share/themes/Sweet-mars"
cp -r "${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Sweet/mars" "${HOME}/.local/share/themes/Sweet-mars"
rm -rf "${HOME}/.local/share/themes/Sweet-mars/.git"

echo "Installing EliverLara/Sweet/master."

rm -rf "${HOME}/.local/share/themes/Sweet"
cp -r "${TMP_DOWNLOAD_DIRECTORY}/EliverLara/Sweet/master" "${HOME}/.local/share/themes/Sweet"
rm -rf "${HOME}/.local/share/themes/Sweet/.git"

cp -r "${HOME}/.local/share/themes/Sweet-mars/kde/aurorae/." "${HOME}/.local/share/aurorae/themes/"
cp -r "${HOME}/.local/share/themes/Sweet-mars/kde/colorschemes/." "${HOME}/.local/share/color-schemes/"
cp -r "${HOME}/.local/share/themes/Sweet-mars/kde/plasma/." "${HOME}/.local/share/plasma/"
cp -r "${HOME}/.local/share/themes/Sweet-mars/kde/kvantum/." "${HOME}/.config/Kvantum/"
cp -r "${HOME}/.local/share/themes/Sweet-mars/kde/konsole/." "${HOME}/.local/share/konsole/"

echo "Installing vinceliuice/Tela-icon-theme."
chmod +x "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Tela-icon-theme/master/install.sh"
"${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Tela-icon-theme/master/install.sh" -a

echo "Installing EliverLara/candy-icons."

rm -rf "${HOME}/.local/share/icons/candy-icons"
cp -r "${TMP_DOWNLOAD_DIRECTORY}/EliverLara/candy-icons/master" "${HOME}/.local/share/icons/candy-icons"
rm -rf "${HOME}/.local/share/icons/candy-icons/.git"

echo "Installing vinceliuice/Layan-cursors."

(
    cd "${TMP_DOWNLOAD_DIRECTORY}/vinceliuice/Layan-cursors/master" || exit 1
    chmod +x ./install.sh
    ./install.sh
)

echo "Installing gvolpe/BeautyLine."

cp -r "${TMP_DOWNLOAD_DIRECTORY}/gvolpe/BeautyLine/main/." "${HOME}/.local/share/icons/"
rm -rf "${HOME}/.local/share/icons/.git"

echo "Installing hack nerd-fonts"

NERD_FONT_VERSION="$(curl -s \
    "https://api.github.com/repos/ryanoasis/nerd-fonts/releases/latest" |
    jq -r ".tag_name")"

if [[ ! -f "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}.zip" ]]; then
    echo "Download font patcher."
    curl -fL \
        "https://github.com/ryanoasis/nerd-fonts/releases/download/${NERD_FONT_VERSION}/FontPatcher.zip" \
        -o "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}.zip"
else
    echo "Font patcher is already present".
fi

rm -rf "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}"
mkdir -p "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}"
unzip "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}.zip" \
    -d "${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}"
export FONT_PATCHER_SCRIPT="${TMP_DOWNLOAD_DIRECTORY}/NerdFontPatcher-${NERD_FONT_VERSION}/font-patcher"

declare -a NERD_FONT_TYPES=(
    JetBrainsMono
    Hack
    Meslo
)

for NERD_FONT_TYPE in "${NERD_FONT_TYPES[@]}"; do
    if [[ ! -f "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}.zip" ]]; then
        echo "Downloading ${NERD_FONT_TYPE}-${NERD_FONT_VERSION}"
        curl -fL \
            "https://github.com/ryanoasis/nerd-fonts/releases/download/${NERD_FONT_VERSION}/${NERD_FONT_TYPE}.zip" \
            -o "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}.zip"
    else
        echo "${NERD_FONT_TYPE}-${NERD_FONT_VERSION} already present."
    fi

    rm -rf "${HOME}/.local/share/fonts/${NERD_FONT_TYPE}" \
        "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}"

    unzip "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}.zip" \
        -d "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}"

    mkdir -p "${HOME}/.local/share/fonts/${NERD_FONT_TYPE}"

    find "${TMP_DOWNLOAD_DIRECTORY}/${NERD_FONT_TYPE}-${NERD_FONT_VERSION}" \
        -type f \( -iname '*.ttf' -o -iname '*.otf' -o -iname '*.ttc' \) \
        -exec mv {} "${HOME}/.local/share/fonts/${NERD_FONT_TYPE}/" \;
done

echo "Installing Cascadia-Code"

CASCADIA_CODE_GITHUB_TAG="$(curl -s \
    "https://api.github.com/repos/microsoft/cascadia-code/releases/latest" |
    jq -r ".tag_name")"

if [[ ! -f "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}.zip" ]]; then
    curl -fL \
        "https://github.com/microsoft/cascadia-code/releases/download/${CASCADIA_CODE_GITHUB_TAG}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}.zip" \
        -o "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}.zip"
else
    echo "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}.zip is already present"
fi

rm -rf "${HOME}/.local/share/fonts/cascadia-code" "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}"
mkdir -p "${HOME}/.local/share/fonts/cascadia-code"

unzip "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}.zip" \
    -d "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}"

find "${TMP_DOWNLOAD_DIRECTORY}/CascadiaCode-${CASCADIA_CODE_GITHUB_TAG:1}" \
    -type f \( -iname '*.ttf' -o -iname '*.otf' -o -iname '*.ttc' \) \
    -exec mv {} "${HOME}/.local/share/fonts/cascadia-code" \;

fc-cache -r -v "${HOME}/.local/share/fonts"

echo "Completed"
