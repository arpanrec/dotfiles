#!/usr/bin/env bash
set -euo pipefail

# 'phonon-qt5-gstreamer'
# For full kde 'plasma-meta' 'kde-applications'
PACMAN_PACKAGES+=('xorg' 'xorg-xinit' 'plasma' 'xdg-desktop-portal' 'sddm' 'konsole' 'kwalletmanager' 'kleopatra'
    'discover' 'partitionmanager' 'skanlite' 'dolphin' 'dolphin-plugins' 'kompare' 'kdegraphics-thumbnailers' 'kcalc'
    'packagekit-qt6' 'kdesdk-thumbnailers' 'ark' 'icoutils' 'qt6-imageformats' 'kimageformats' 'kate' 'qt5-imageformats'
    'tk' 'kio-gdrive' 'spectacle' 'gwenview' 'kamera' 'kamoso' 'kdialog' 'kvantum' 'materia-kde' 'kdecoration'
    'qt5-declarative' 'qt5-x11extras' 'qt5-wayland' 'qt6-wayland' 'egl-wayland' 'egl-wayland2')

# materia-kde materia UI based themes support, kvantum-qt5 has moved to aur
# materia-gtk-theme this is required for some of the themes like prof and sweet
# gtk-engine-murrine and gtk-engines is required by materia-gtk-theme
# adapta-gtk-theme Gtk+ theme based on Material Design
PACMAN_PACKAGES+=('appmenu-gtk-module' 'webkit2gtk' 'materia-gtk-theme' 'adapta-gtk-theme')

PACMAN_PACKAGES+=('networkmanager-openvpn' 'libnma')

PACMAN_BASIC_PACKAGES+=('cups' 'cups-pdf' 'hplip' 'usbutils' 'cups-pk-helper')

PACMAN_BASIC_PACKAGES+=('ffmpeg' 'yt-dlp')

PACMAN_PACKAGES+=('cryfs' 'encfs' 'gocryptfs') # For kde vault

PACMAN_PACKAGES+=('libavtp' 'lib32-alsa-plugins' 'lib32-libavtp' 'lib32-libsamplerate' 'lib32-speexdsp'
    'lib32-glib2')

PACMAN_PACKAGES+=('wireplumber' 'pipewire' 'pipewire-pulse' 'pipewire-alsa' 'sof-firmware' 'pipewire-jack'
    'lib32-pipewire-jack' 'alsa-firmware' 'alsa-utils' 'gst-plugin-pipewire' 'pipewire-v4l2' 'pipewire-zeroconf'
    'lib32-pipewire-v4l2' 'pavucontrol' 'lib32-pipewire')

PACMAN_PACKAGES+=('veracrypt' 'keepassxc')

PACMAN_PACKAGES+=('wireguard-tools')

PACMAN_PACKAGES+=('noto-fonts' 'noto-fonts-cjk' 'noto-fonts-emoji' 'noto-fonts-extra' 'waybar' 'otf-font-awesome'
    'adobe-source-sans-fonts')

# 'yubikey-manager-qt' Is broken
PACMAN_PACKAGES+=('yubikey-personalization' 'yubikey-personalization-gui' 'yubikey-manager')

#  'duplicity'
PACMAN_PACKAGES+=('timeshift' 'vorta' 'deja-dup' 'borgmatic')

PACMAN_PACKAGES+=('system-config-printer' 'print-manager')

PACMAN_PACKAGES+=('ffmpegthumbnailer' 'gst-libav' 'gstreamer' 'gst-plugins-bad' 'gst-plugins-good'
    'gst-plugins-ugly' 'taglib' 'gst-plugins-base' 'a52dec' 'faac' 'faad2' 'flac' 'jasper' 'lame' 'libdca' 'libdv'
    'libmad' 'libmpeg2' 'libtheora' 'libvorbis' 'libxv' 'wavpack' 'x264' 'xvidcore' 'vlc' 'vlc-plugin-ffmpeg'
    'vlc-plugins-all' 'haruna' 'libheif' 'ffmpegthumbs')

# Not Sure if this is needed Removed # libva-vdpau-driver lib32-libva-vdpau-driver mesa-vdpau lib32-mesa-vdpau
PACMAN_PACKAGES+=('mesa' 'libva-mesa-driver' 'lib32-libva-mesa-driver' 'lib32-mesa' 'libvdpau-va-gl' 'mesa-utils')

# VMware Workstation dependencies
PACMAN_PACKAGES+=('gtkmm3' 'pcsclite' 'swtpm' 'openssl-1.1' 'realtime-privileges' 'linux-headers')

PACMAN_PACKAGES+=('gimp' 'qbittorrent' 'signal-desktop' 'nextcloud-client')

if lspci | grep -E "(VGA|3D)" | grep -E "(NVIDIA|GeForce)"; then
    ALL_PAKGS+=('nvidia-settings' 'nvidia-prime' 'lib32-nvidia-utils' 'libvdpau-va-gl')
fi

if lspci | grep -E "(VGA|3D)" | grep -E "(Radeon|Advanced Micro Devices)"; then
    ALL_PAKGS+=('xf86-video-amdgpu' 'xf86-video-ati' 'vulkan-radeon' 'lib32-vulkan-radeon' 'lib32-vulkan-mesa-layers')
fi

if lspci | grep -E "(VGA|3D)" | grep -E "(Integrated Graphics Controller|Intel Corporation)"; then
    ALL_PAKGS+=('libvdpau-va-gl' 'lib32-vulkan-intel' 'vulkan-intel' 'libva-intel-driver'
        'libva-utils' 'mesa' 'intel-media-driver')
fi

pacman -S --needed --noconfirm "${PACMAN_PACKAGES[@]}"

systemctl enable sddm
systemctl set-default graphical.target

AUR_PACKAGES=('google-chrome' 'brave-bin' 'sublime-text-4' 'onlyoffice-bin' 'nordvpn-bin' 'yubico-authenticator-bin')

sudo -H -u arch-yay-installer-user bash -c "cd ~ && \
        yay -S --answerclean None --answerdiff None --noconfirm --needed $(printf " %s" "${AUR_PACKAGES[@]}")"

while orphaned=$(pacman -Qtdq); do
    [[ -z "${orphaned}" ]] && break
    pacman -R --noconfirm "${orphaned}"
done

echo "Its a good idea to run 'pacman -R \$(pacman -Qtdq)' or 'yay -R \$(yay -Qtdq)'."

echo "Completed"
